#!/usr/bin/env node

/**
 * Generate Cross-League Curation SQL
 * 
 * Analyzes teams across all leagues and generates SQL to merge related teams
 * under parent clubs. Output can be reviewed, edited, and version controlled.
 * 
 * Usage: node generate-curation.js > ../data/045-cross-league-curation.sql
 */

const { Client } = require('pg');

// Curation rules - patterns that indicate teams belong together
const CURATION_RULES = [
  {
    name: 'Central Park Rangers FC',
    pattern: /central\s*park\s*rangers/i,
    parentName: 'Central Park Rangers FC',
    childPatterns: ['II', 'III', 'Green', 'Orange', 'Red', 'Blue', 'Legends', 'Old Boys', 'Young Boys', 'United', 'Lower East', 'Kickoff', '1999']
  },
  {
    name: 'Lighthouse 1893 SC',
    pattern: /lighthouse|1893\s*sc/i,
    parentName: 'Lighthouse 1893 SC',
    childPatterns: ['Boys Club', 'Old Timers']
  },
  {
    name: 'Manhattan Celtic',
    pattern: /manhattan\s*celtic/i,
    parentName: 'Manhattan Celtic',
    childPatterns: ['II', 'III', 'Bhoys', 'Masters']
  },
  {
    name: 'Manhattan FC',
    pattern: /^manhattan\s*fc/i,  // Exact match to avoid catching Manhattan Celtic/Kickers
    parentName: 'Manhattan FC',
    childPatterns: ['II', 'III']
  },
  {
    name: 'Manhattan Kickers',
    pattern: /manhattan\s*kickers/i,
    parentName: 'Manhattan Kickers',
    childPatterns: ['II', 'Legends']
  },
  {
    name: 'Brooklyn City FC',
    pattern: /brooklyn\s*city\s*fc/i,
    parentName: 'Brooklyn City FC',
    childPatterns: ['II', 'III', 'Reserves']
  },
  {
    name: 'Barnstonworth Rovers FC',
    pattern: /barnstonworth\s*rovers/i,
    parentName: 'Barnstonworth Rovers FC',
    childPatterns: ['Old Boys']
  },
  {
    name: 'Alloy Soccer Club',
    pattern: /alloy\s*soccer\s*club/i,
    parentName: 'Alloy Soccer Club',
    childPatterns: ['Reserves']
  },
  {
    name: 'Block FC',
    pattern: /^block\s*fc/i,
    parentName: 'Block FC',
    childPatterns: ['II']
  },
  {
    name: 'Borgetto FC',
    pattern: /borgetto\s*fc/i,
    parentName: 'Borgetto FC',
    childPatterns: ['II']
  },
  {
    name: 'CD Iberia',
    pattern: /cd\s*iberia/i,
    parentName: 'CD Iberia',
    childPatterns: ['II']
  },
  // Add more club patterns here as you discover them
];

// Name normalization for fuzzy matching
function normalize(str) {
  return str
    .toLowerCase()
    .replace(/\s+/g, ' ')
    .replace(/[^\w\s]/g, '')
    .trim();
}

// Check if team name matches a curation rule
function findCurationRule(teamName) {
  for (const rule of CURATION_RULES) {
    if (rule.pattern.test(teamName)) {
      return rule;
    }
  }
  return null;
}

// Check if team is a child team (has color/level suffix)
function isChildTeam(teamName, rule) {
  const normalized = normalize(teamName);
  return rule.childPatterns.some(pattern => 
    normalized.includes(normalize(pattern))
  );
}

async function generateCuration() {
  const client = new Client({
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    database: process.env.DB_NAME || 'footballhome',
    user: process.env.DB_USER || 'footballhome_user',
    password: process.env.DB_PASSWORD || 'footballhome_pass'
  });

  try {
    await client.connect();

    // Get all teams with their current club assignments
    const teamsResult = await client.query(`
      SELECT 
        t.id as team_id,
        t.name as team_name,
        t.club_id,
        c.id as club_id_from_join,
        c.name as club_name,
        t.source_system_id,
        ss.name as source_system
      FROM teams t
      LEFT JOIN clubs c ON t.club_id = c.id
      LEFT JOIN source_systems ss ON t.source_system_id = ss.id
      ORDER BY t.name
    `);

    const teams = teamsResult.rows;
    
    // Get all clubs for parent club lookup
    const clubsResult = await client.query(`
      SELECT id, name, organization_id
      FROM clubs
      ORDER BY name
    `);
    
    const clubsByName = {};
    for (const club of clubsResult.rows) {
      clubsByName[club.name] = club;
    }

    // Output SQL header
    console.log(`-- ============================================================================`);
    console.log(`-- 045-cross-league-curation.sql`);
    console.log(`-- AUTO-GENERATED: ${new Date().toISOString()}`);
    console.log(`-- ============================================================================`);
    console.log(`--`);
    console.log(`-- Purpose: Merge related teams under parent clubs across all leagues`);
    console.log(`-- Generated by: database/scripts/generate-curation.js`);
    console.log(`--`);
    console.log(`-- REVIEW CAREFULLY before committing!`);
    console.log(`-- Edit/delete any merges that don't look right.`);
    console.log(`--`);
    console.log();

    // Group teams by curation rules
    const mergeGroups = {};
    const unmatched = [];

    for (const team of teams) {
      const rule = findCurationRule(team.team_name);
      
      if (rule) {
        if (!mergeGroups[rule.name]) {
          mergeGroups[rule.name] = {
            rule,
            parentClub: clubsByName[rule.parentName] || null,  // Look up parent club directly
            teams: []
          };
        }
        
        // Add all matching teams to the group
        mergeGroups[rule.name].teams.push(team);
      } else {
        unmatched.push(team);
      }
    }

    // Generate SQL for each merge group
    for (const [groupName, group] of Object.entries(mergeGroups)) {
      if (group.teams.length === 0) continue;

      console.log(`-- ============================================================================`);
      console.log(`-- ${groupName}`);
      console.log(`-- ============================================================================`);
      console.log();

      // If no parent club exists, create one
      if (!group.parentClub) {
        console.log(`-- Create parent club: ${group.rule.parentName}`);
        console.log(`DO $$`);
        console.log(`DECLARE`);
        console.log(`    parent_club_id INTEGER;`);
        console.log(`    parent_org_id INTEGER;`);
        console.log(`BEGIN`);
        console.log(`    -- Create parent organization`);
        console.log(`    INSERT INTO organizations (name, short_name, is_active)`);
        console.log(`    VALUES ('${group.rule.parentName}', '${group.rule.parentName}', true)`);
        console.log(`    RETURNING id INTO parent_org_id;`);
        console.log();
        console.log(`    -- Create parent club`);
        console.log(`    INSERT INTO clubs (name, organization_id, is_active)`);
        console.log(`    VALUES ('${group.rule.parentName}', parent_org_id, true)`);
        console.log(`    RETURNING id INTO parent_club_id;`);
        console.log();
      } else {
        console.log(`-- Using existing parent club: ${group.parentClub.name} (club_id: ${group.parentClub.id})`);
        console.log(`DO $$`);
        console.log(`DECLARE`);
        console.log(`    parent_club_id INTEGER := ${group.parentClub.id};`);
        console.log(`BEGIN`);
        console.log();
      }

      // Merge all teams under parent club
      const clubsToDelete = new Set();
      for (const team of group.teams) {
        // Skip if team already has the parent club
        if (group.parentClub && team.club_id === group.parentClub.id) {
          console.log(`    -- Skip: ${team.team_name} (${team.source_system}) - already has parent club`);
          continue;
        }
        
        console.log(`    -- Merge: ${team.team_name} (${team.source_system})`);
        console.log(`    UPDATE teams SET club_id = parent_club_id WHERE id = ${team.team_id};`);
        
        // Track orphan clubs for deletion
        if (team.club_id && (!group.parentClub || team.club_id !== group.parentClub.id)) {
          clubsToDelete.add(team.club_id);
        }
        console.log();
      }

      // Clean up orphan clubs
      if (clubsToDelete.size > 0) {
        console.log(`    -- Clean up orphan clubs`);
        console.log(`    DELETE FROM clubs WHERE id IN (${Array.from(clubsToDelete).join(', ')});`);
        console.log();
      }

      console.log(`END $$;`);
      console.log();
    }

    // Output summary of unmatched teams
    console.log(`-- ============================================================================`);
    console.log(`-- UNMATCHED TEAMS (need manual review)`);
    console.log(`-- ============================================================================`);
    console.log(`--`);
    console.log(`-- The following teams didn't match any curation rules.`);
    console.log(`-- Review and add rules to generate-curation.js if needed.`);
    console.log(`--`);

    for (const team of unmatched) {
      console.log(`-- ${team.team_name} (${team.source_system})`);
    }

    await client.end();

  } catch (error) {
    console.error('-- ERROR:', error.message);
    process.exit(1);
  }
}

generateCuration();
