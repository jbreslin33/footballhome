#!/bin/bash
set -e
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

CLAUDE_MODEL="claude-sonnet-4-20250514"
CLAUDE_API_URL="https://api.anthropic.com/v1/messages"

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo -e "${RED}âœ—${NC} ANTHROPIC_API_KEY not set"
    echo -e "${BLUE}â„¹${NC} Run: ./scripts/setup-claude-cli.sh"
    exit 1
fi

call_claude() {
    local prompt="$1"
    local system_prompt="$2"
    
    local escaped_prompt=$(python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))' <<< "$prompt")
    local escaped_system=$(python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))' <<< "$system_prompt")
    
    local json_payload=$(cat <<JSONEOF
{
  "model": "$CLAUDE_MODEL",
  "max_tokens": 4096,
  "system": $escaped_system,
  "messages": [{"role": "user", "content": $escaped_prompt}]
}
JSONEOF
)
    
    local response=$(curl -s -X POST "$CLAUDE_API_URL" \
        -H "Content-Type: application/json" \
        -H "x-api-key: $ANTHROPIC_API_KEY" \
        -H "anthropic-version: 2023-06-01" \
        -d "$json_payload")
    
    if echo "$response" | grep -q '"type":"error"'; then
        echo -e "${RED}âœ—${NC} API Error:"
        echo "$response"
        exit 1
    fi
    
    if command -v jq >/dev/null 2>&1; then
        echo "$response" | jq -r '.content[0].text'
    else
        python3 -c 'import json,sys; print(json.loads(sys.stdin.read())["content"][0]["text"])' <<< "$response"
    fi
}

start_chat() {
    echo -e "${BLUE}â„¹${NC} ðŸ¤– Claude AI - Football Home Context"
    echo -e "${GREEN}âœ“${NC} Ready! (Type 'exit' to quit)"
    echo ""
    
    SYSTEM_PROMPT="You are an expert coding assistant for Football Home. Tech stack: C++17 backend with libpqxx, Vanilla JavaScript frontend, PostgreSQL. Help with code, debugging, SQL. Be concise."
    
    while true; do
        echo -ne "${BLUE}You:${NC} "
        read -r user_input
        
        [[ "$user_input" =~ ^(exit|quit|q)$ ]] && break
        [ -z "$user_input" ] && continue
        
        echo -e "\n${GREEN}Claude:${NC}"
        call_claude "$user_input" "$SYSTEM_PROMPT"
        echo ""
    done
    echo -e "${GREEN}âœ“${NC} Goodbye!"
}

case "${1:-}" in
    chat) start_chat ;;
    query) call_claude "$2" "You are a coding assistant for Football Home (C++, JS, PostgreSQL). Be concise." ;;
    *) echo "Usage: $0 {chat|query \"text\"}" ;;
esac
