<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSVP - Football Home</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <style>
        .rsvp-container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .event-info {
            text-align: center;
            padding: 1rem;
            background: var(--primary-gradient);
            color: white;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .rsvp-buttons {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .rsvp-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rsvp-btn.yes {
            background: #22c55e;
            color: white;
        }
        
        .rsvp-btn.no {
            background: #ef4444;
            color: white;
        }
        
        .rsvp-btn.maybe {
            background: #f59e0b;
            color: white;
        }
        
        .rsvp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .rsvp-btn.selected {
            outline: 3px solid #1e293b;
            transform: scale(1.05);
        }
        
        .notes-section {
            margin: 2rem 0;
        }
        
        .notes-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .submit-btn:hover {
            background: var(--primary-dark);
        }
        
        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .loading, .error, .success {
            text-align: center;
            padding: 2rem;
        }
        
        .error {
            color: #ef4444;
        }
        
        .success {
            color: #22c55e;
        }
        
        .current-status {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="rsvp-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading your RSVP...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <h2>‚ö†Ô∏è Oops!</h2>
            <p id="error-message"></p>
        </div>

        <div id="rsvp-form" style="display: none;">
            <div class="event-info">
                <h1>‚öΩ <span id="event-title"></span></h1>
                <p><strong><span id="event-date"></span></strong></p>
                <p>üìç <span id="event-location"></span></p>
            </div>

            <div id="current-status" class="current-status" style="display: none;">
                <p><strong>Current RSVP:</strong> <span id="current-rsvp"></span></p>
            </div>

            <div class="rsvp-section">
                <h3>Hey <span id="player-name"></span>! üëã</h3>
                <p>Are you coming to this <span id="event-type"></span>?</p>
                
                <div class="rsvp-buttons">
                    <button class="rsvp-btn yes" data-status="yes">
                        ‚úÖ Yes!
                    </button>
                    <button class="rsvp-btn maybe" data-status="maybe">
                        ü§î Maybe
                    </button>
                    <button class="rsvp-btn no" data-status="no">
                        ‚ùå Can't make it
                    </button>
                </div>

                <div class="notes-section">
                    <label for="notes"><strong>Notes (optional):</strong></label>
                    <textarea id="notes" class="notes-input" placeholder="Any comments for the coach..."></textarea>
                </div>

                <button id="submit-btn" class="submit-btn" disabled>
                    Submit RSVP
                </button>
            </div>
        </div>

        <div id="success" class="success" style="display: none;">
            <h2>üéâ RSVP Submitted!</h2>
            <p>Thanks for responding! Your coach will see your RSVP status.</p>
            <p><strong>Your response:</strong> <span id="final-status"></span></p>
        </div>
    </div>

    <script>
        class RSVPPage {
            constructor() {
                this.token = this.getTokenFromURL();
                this.selectedStatus = null;
                this.eventData = null;
                this.init();
            }

            getTokenFromURL() {
                const path = window.location.pathname;
                return path.split('/rsvp/')[1];
            }

            async init() {
                if (!this.token) {
                    this.showError('Invalid RSVP link');
                    return;
                }

                try {
                    await this.loadRSVPData();
                    this.setupEventListeners();
                    this.showRSVPForm();
                } catch (error) {
                    console.error('Init error:', error);
                    this.showError('Failed to load RSVP information');
                }
            }

            async loadRSVPData() {
                const response = await fetch(`/api/rsvp/${this.token}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load RSVP data');
                }

                this.eventData = data;
                this.populateEventInfo();
            }

            populateEventInfo() {
                const { event, player, currentRsvp } = this.eventData;

                document.getElementById('event-title').textContent = event.title;
                document.getElementById('event-date').textContent = new Date(event.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                document.getElementById('event-location').textContent = event.location || 'TBD';
                document.getElementById('event-type').textContent = event.type;
                document.getElementById('player-name').textContent = player.name;

                // Show current RSVP if exists
                if (currentRsvp) {
                    document.getElementById('current-status').style.display = 'block';
                    document.getElementById('current-rsvp').textContent = 
                        currentRsvp.charAt(0).toUpperCase() + currentRsvp.slice(1);
                }
            }

            setupEventListeners() {
                // RSVP button clicks
                document.querySelectorAll('.rsvp-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectStatus(e.target.dataset.status);
                    });
                });

                // Submit button
                document.getElementById('submit-btn').addEventListener('click', () => {
                    this.submitRSVP();
                });
            }

            selectStatus(status) {
                this.selectedStatus = status;

                // Update button states
                document.querySelectorAll('.rsvp-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector(`[data-status="${status}"]`).classList.add('selected');

                // Enable submit button
                document.getElementById('submit-btn').disabled = false;
            }

            async submitRSVP() {
                if (!this.selectedStatus) return;

                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                try {
                    const notes = document.getElementById('notes').value;
                    
                    const response = await fetch(`/api/rsvp/${this.token}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: this.selectedStatus,
                            notes: notes || null
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to submit RSVP');
                    }

                    this.showSuccess();
                } catch (error) {
                    console.error('Submit error:', error);
                    this.showError('Failed to submit RSVP. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit RSVP';
                }
            }

            showRSVPForm() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('rsvp-form').style.display = 'block';
            }

            showSuccess() {
                document.getElementById('rsvp-form').style.display = 'none';
                document.getElementById('final-status').textContent = 
                    this.selectedStatus.charAt(0).toUpperCase() + this.selectedStatus.slice(1);
                document.getElementById('success').style.display = 'block';
            }

            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').textContent = message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new RSVPPage();
        });
    </script>
</body>
</html>