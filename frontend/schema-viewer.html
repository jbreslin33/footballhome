<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Schema - Football Home</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8f9fa;
            color: #212529;
        }
        
        .header {
            background: #1976d2;
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .search-bar {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            display: grid;
            grid-template-columns: 550px 1fr;
            height: calc(100vh - 120px);
            gap: 0;
        }
        
        .sidebar {
            background: white;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 40px;
        }
        
        .category {
            margin-bottom: 48px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 24px;
            background: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 17px;
            color: #495057;
            margin-bottom: 16px;
            user-select: none;
        }
        
        .category-header:hover {
            background: #dee2e6;
        }
        
        .category-toggle {
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .category.collapsed .category-toggle {
            transform: rotate(-90deg);
        }
        
        .category-tables {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-left: 20px;
        }
        
        .category.collapsed .category-tables {
            display: none;
        }
        
        .table-item {
            padding: 16px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            color: #495057;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        
        .table-item:hover {
            background: #f8f9fa;
            border-left-color: #1976d2;
        }
        
        .table-item.active {
            background: #e3f2fd;
            border-left-color: #1976d2;
            color: #1976d2;
            font-weight: 500;
        }
        
        .table-count {
            float: right;
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .detail-panel {
            background: white;
            overflow-y: auto;
            padding: 60px 80px;
        }
        
        .detail-panel.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 20px;
        }
        
        .table-header {
            margin-bottom: 60px;
            padding-bottom: 32px;
            border-bottom: 4px solid #1976d2;
        }
        
        .table-name {
            font-size: 40px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 16px;
        }
        
        .table-meta {
            color: #6c757d;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 64px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        table th {
            background: #f8f9fa;
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        table td {
            padding: 18px 20px;
            border-bottom: 1px solid #f1f3f5;
        }
        
        table tr:last-child td {
            border-bottom: none;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        table tr.fk-row {
            background: #fff8e1;
        }
        
        table tr.fk-row:hover {
            background: #fff3cd;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 6px;
        }
        
        .badge-primary {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .badge-info {
            background: #e1f5fe;
            color: #0277bd;
        }
        
        .code {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .no-results {
            padding: 48px;
            text-align: center;
            color: #6c757d;
            font-size: 15px;
        }
        
        /* Start with categories collapsed */
        .category.collapsed .category-tables {
            display: none;
        }
        
        /* Relationship Cards */
        .relationship-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 32px;
            margin-top: 24px;
        }
        
        .relationship-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 32px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .relationship-card:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .relationship-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .relationship-arrow {
            font-size: 32px;
            color: #1976d2;
            font-weight: bold;
        }
        
        .relationship-table {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
            flex: 1;
        }
        
        .relationship-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .relationship-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .relationship-label {
            color: #6c757d;
            font-weight: 600;
            min-width: 80px;
        }
        
        .relationship-value {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 15px;
            color: #212529;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üóÇÔ∏è Database Schema - Football Home</h1>
        <div class="search-bar">
            <input type="text" id="search-input" class="search-input" placeholder="Search tables...">
            <button id="expand-all" class="btn">Expand All</button>
            <button id="collapse-all" class="btn">Collapse All</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar" id="sidebar"></div>
        <div class="detail-panel empty" id="detail-panel">
            <div>üëà Select a table to view details</div>
        </div>
    </div>
    
    <script>
        let schemaData = null;
        let currentTable = null;
        
        // Dynamic categorization based on table name patterns and relationships
        function categorizeTable(tableName, table) {
            // Lookup tables (end with _types, _statuses, _levels, etc.)
            if (/_types$|_statuses$|_levels$|_methods$|_roles$/.test(tableName)) {
                return 'Lookup Tables';
            }
            
            // Match tables
            if (/^match/.test(tableName)) {
                return 'Matches & Games';
            }
            
            // Schedule tables
            if (/^schedule/.test(tableName)) {
                return 'Scheduling';
            }
            
            // League structure
            if (/^(leagues|seasons|conferences|divisions)$/.test(tableName)) {
                return 'League Structure';
            }
            
            // Teams and rosters
            if (/^(teams|division_rosters|division_roster_)/.test(tableName)) {
                return 'Teams & Rosters';
            }
            
            // People and identity
            if (/^(persons|users|admins|players|coaches|external_identities)/.test(tableName)) {
                return 'People & Identity';
            }
            
            // Organizations and clubs
            if (/^(organizations|organization_|clubs)$/.test(tableName)) {
                return 'Organizations & Clubs';
            }
            
            // Chat and communication
            if (/^chat/.test(tableName)) {
                return 'Communication';
            }
            
            // Venues
            if (/^venue/.test(tableName)) {
                return 'Venues';
            }
            
            // Statistics
            if (/_stats$|_standings$/.test(tableName)) {
                return 'Statistics';
            }
            
            // Core system
            if (/^(source_systems|governing_bodies|scrape_|sports|positions)/.test(tableName)) {
                return 'Core System';
            }
            
            return 'Other';
        }
        
        function getCategorizedTables(filter = '') {
            if (!schemaData) return {};
            
            const filterLower = filter.toLowerCase();
            const categories = {};
            
            schemaData.tables
                .filter(t => !filter || t.name.toLowerCase().includes(filterLower))
                .forEach(table => {
                    const category = categorizeTable(table.name, table);
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push(table);
                });
            
            // Sort categories alphabetically, but keep Lookup Tables and Core System first
            const sortedCategories = {};
            const priorityCategories = ['Core System', 'Lookup Tables'];
            
            priorityCategories.forEach(cat => {
                if (categories[cat]) {
                    sortedCategories[cat] = categories[cat].sort((a, b) => a.name.localeCompare(b.name));
                }
            });
            
            Object.keys(categories)
                .filter(cat => !priorityCategories.includes(cat))
                .sort()
                .forEach(cat => {
                    sortedCategories[cat] = categories[cat].sort((a, b) => a.name.localeCompare(b.name));
                });
            
            return sortedCategories;
        }
        
        async function loadSchema() {
            try {
                const response = await fetch('/api/system-admin/schema');
                if (!response.ok) throw new Error('Failed to load schema');
                schemaData = await response.json();
                renderSidebar();
            } catch (error) {
                console.error('Error loading schema:', error);
                document.getElementById('sidebar').innerHTML = 
                    '<div class="no-results">‚ùå Failed to load schema</div>';
            }
        }
        
        function renderSidebar(filter = '') {
            const sidebar = document.getElementById('sidebar');
            const categories = getCategorizedTables(filter);
            
            let html = '';
            let hasResults = false;
            
            for (const [categoryName, tables] of Object.entries(categories)) {
                if (tables.length === 0) continue;
                hasResults = true;
                
                html += `
                    <div class="category collapsed">
                        <div class="category-header" onclick="toggleCategory(this)">
                            <span class="category-toggle">‚ñº</span>
                            <span>${categoryName}</span>
                            <span class="table-count">${tables.length}</span>
                        </div>
                        <div class="category-tables">
                            ${tables.map(table => `
                                <div class="table-item" onclick="selectTable('${table.name}')" data-table="${table.name}">
                                    ${table.name}
                                    <span class="table-count">${table.columns.length}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            sidebar.innerHTML = hasResults ? html : '<div class="no-results">No tables found</div>';
        }
        
        function toggleCategory(header) {
            header.parentElement.classList.toggle('collapsed');
        }
        
        function selectTable(tableName) {
            currentTable = schemaData.tables.find(t => t.name === tableName);
            if (!currentTable) return;
            
            // Update active state
            document.querySelectorAll('.table-item').forEach(item => {
                item.classList.toggle('active', item.dataset.table === tableName);
            });
            
            renderTableDetails();
        }
        
        function renderTableDetails() {
            const panel = document.getElementById('detail-panel');
            if (!currentTable) {
                panel.className = 'detail-panel empty';
                panel.innerHTML = '<div>üëà Select a table to view details</div>';
                return;
            }
            
            panel.className = 'detail-panel';
            
            const primaryKeys = currentTable.columns.filter(c => c.primary_key).map(c => c.name);
            const foreignKeys = currentTable.foreign_keys || [];
            const indexes = currentTable.indexes || [];
            
            // Find reverse foreign keys (tables that reference this table)
            const referencedBy = schemaData.tables
                .filter(t => t.foreign_keys?.some(fk => fk.foreign_table === currentTable.name))
                .map(t => ({
                    table: t.name,
                    keys: t.foreign_keys.filter(fk => fk.foreign_table === currentTable.name)
                }));
            
            panel.innerHTML = `
                <div class="table-header">
                    <div class="table-name">${currentTable.name}</div>
                    <div class="table-meta">
                        ${currentTable.columns.length} columns
                        ${primaryKeys.length > 0 ? `‚Ä¢ PK: ${primaryKeys.join(', ')}` : ''}
                        ${foreignKeys.length > 0 ? `‚Ä¢ ${foreignKeys.length} foreign keys` : ''}
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">üìã Columns</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Nullable</th>
                                <th>Default</th>
                                <th>Attributes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentTable.columns.map(col => {
                                const isFk = foreignKeys.some(fk => fk.column === col.name);
                                return `
                                <tr class="${isFk ? 'fk-row' : ''}">
                                    <td><span class="code">${col.name}</span></td>
                                    <td>${col.type}</td>
                                    <td>${col.nullable === 'YES' ? '‚úì' : '‚úó'}</td>
                                    <td>${col.default || '‚Äî'}</td>
                                    <td>
                                        ${col.primary_key ? '<span class="badge badge-primary">PK</span> ' : ''}
                                        ${isFk ? '<span class="badge badge-info">FK</span>' : ''}
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${foreignKeys.length > 0 ? `
                    <div class="section">
                        <div class="section-title">üîó Foreign Keys (References)</div>
                        <div class="relationship-grid">
                            ${foreignKeys.map(fk => `
                                <div class="relationship-card" onclick="selectTable('${fk.foreign_table}')">
                                    <div class="relationship-header">
                                        <div class="relationship-table">${currentTable.name}</div>
                                        <div class="relationship-arrow">‚Üí</div>
                                        <div class="relationship-table">${fk.foreign_table}</div>
                                    </div>
                                    <div class="relationship-details">
                                        <div class="relationship-row">
                                            <span class="relationship-label">Column:</span>
                                            <span class="relationship-value">${fk.column}</span>
                                        </div>
                                        <div class="relationship-row">
                                            <span class="relationship-label">References:</span>
                                            <span class="relationship-value">${fk.foreign_table}.${fk.foreign_column}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${referencedBy.length > 0 ? `
                    <div class="section">
                        <div class="section-title">üîô Referenced By (Incoming)</div>
                        <div class="relationship-grid">
                            ${referencedBy.map(ref => `
                                <div class="relationship-card" onclick="selectTable('${ref.table}')">
                                    <div class="relationship-header">
                                        <div class="relationship-table">${ref.table}</div>
                                        <div class="relationship-arrow">‚Üí</div>
                                        <div class="relationship-table">${currentTable.name}</div>
                                    </div>
                                    <div class="relationship-details">
                                        ${ref.keys.map(k => `
                                            <div class="relationship-row">
                                                <span class="relationship-label">Via:</span>
                                                <span class="relationship-value">${ref.table}.${k.column} ‚Üí ${currentTable.name}.${k.foreign_column}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${indexes.length > 0 ? `
                    <div class="section">
                        <div class="section-title">üîç Indexes</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Columns</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${indexes.map(idx => `
                                    <tr>
                                        <td><span class="code">${idx.name}</span></td>
                                        <td>${idx.columns.join(', ')}</td>
                                        <td>
                                            ${idx.unique ? '<span class="badge badge-warning">UNIQUE</span>' : '<span class="badge badge-success">INDEX</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;
        }
        
        // Event listeners
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderSidebar(e.target.value);
        });
        
        document.getElementById('expand-all').addEventListener('click', () => {
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.remove('collapsed');
            });
        });
        
        document.getElementById('collapse-all').addEventListener('click', () => {
            document.querySelectorAll('.category').forEach(cat => {
                cat.classList.add('collapsed');
            });
        });
        
        // Load schema on page load
        loadSchema();
    </script>
</body>
</html>
                
                const nodes = [];
                const edges = [];
                const tableMap = {};
                
                data.tables.forEach(table => {
                    // Build label with table name and all columns
                    const columnLines = table.columns.map(col => {
                        const pk = col.primary_key ? 'üîë ' : '  ';
                        const fk = table.foreign_keys.some(f => f.column === col.name) ? ' ‚Üí' : '';
                        const type = col.type.length > 15 ? col.type.substring(0, 12) + '...' : col.type;
                        return `${pk}${col.name}: ${type}${fk}`;
                    });
                    
                    const fullLabel = `${table.name}\n${'‚îÄ'.repeat(table.name.length)}\n${columnLines.join('\n')}`;
                    
                    // Tooltip with more details
                    const columnDetails = table.columns.map(col => {
                        const pk = col.primary_key ? 'üîë ' : '';
                        const nullable = col.nullable === 'NO' ? ' NOT NULL' : '';
                        const def = col.default ? ` DEFAULT ${col.default}` : '';
                        return `${pk}${col.name}: ${col.type}${nullable}${def}`;
                    }).join('\\n');
                    
                    nodes.push({
                        id: table.name,
                        label: fullLabel,
                        title: `<b>${table.name}</b>\\n\\n${columnDetails}`,
                        shape: 'box',
                        color: {
                            background: '#ffffff',
                            border: '#2196F3',
                            highlight: { background: '#e3f2fd', border: '#1976d2' }
                        },
                        font: { size: 11, face: 'Monaco, Consolas, "Courier New", monospace', align: 'left' },
                        margin: 20,
                        widthConstraint: { minimum: 220, maximum: 350 },
                        heightConstraint: { minimum: 100 }
                    });
                    
                    tableMap[table.name] = table;
                    
                    table.foreign_keys.forEach(fk => {
                        edges.push({
                            from: table.name,
                            to: fk.foreign_table,
                            label: fk.column,
                            arrows: 'to',
                            color: { color: '#2196F3', highlight: '#ff5722' },
                            font: { size: 10, align: 'middle' },
                            title: `${table.name}.${fk.column} ‚Üí ${fk.foreign_table}.${fk.foreign_column}`
                        });
                    });
                });
                
                const container = document.getElementById('schema-network');
                const networkData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
                
                const options = {
                    layout: {
                        improvedLayout: true,
                        hierarchical: {
                            enabled: false
                        }
                    },
                    physics: {
                        enabled: true,
                        barnesHut: {
                            gravitationalConstant: -800000,
                            centralGravity: 0,
                            springLength: 700,
                            springConstant: 0.0001,
                            damping: 0.7,
                            avoidOverlap: 12
                        },
                        stabilization: {
                            enabled: true,
                            iterations: 5000,
                            updateInterval: 50
                        },
                        minVelocity: 1.5
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100,
                        navigationButtons: true,
                        keyboard: true
                    },
                    nodes: {
                        borderWidth: 2,
                        borderWidthSelected: 4,
                        shapeProperties: {
                            borderRadius: 4
                        }
                    },
                    edges: {
                        width: 2,
                        smooth: {
                            type: 'curvedCW',
                            roundness: 0.6
                        },
                        arrows: {
                            to: {
                                enabled: true,
                                scaleFactor: 0.5
                            }
                        },
                        length: 400,
                        avoidOverlap: true
                    }
                };
                
                const network = new vis.Network(container, networkData, options);
                
                // Event handlers
                document.getElementById('schema-fit').addEventListener('click', () => {
                    network.fit({ animation: true });
                });
                
                document.getElementById('schema-zoom-in').addEventListener('click', () => {
                    const scale = network.getScale();
                    network.moveTo({ scale: scale * 1.2, animation: true });
                });
                
                document.getElementById('schema-zoom-out').addEventListener('click', () => {
                    const scale = network.getScale();
                    network.moveTo({ scale: scale * 0.8, animation: true });
                });
                
                document.getElementById('schema-reset').addEventListener('click', () => {
                    network.fit({ animation: true });
                });
                
                // Show table details on click
                network.on('click', (params) => {
                    const detailsDiv = document.getElementById('schema-details');
                    
                    if (params.nodes.length > 0) {
                        const tableName = params.nodes[0];
                        const table = tableMap[tableName];
                        
                        let detailsHTML = `
                            <h3>üìã ${tableName}</h3>
                            <h4>Columns (${table.columns.length})</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Nullable</th>
                                        <th>Default</th>
                                        <th>Primary Key</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        table.columns.forEach(col => {
                            detailsHTML += `
                                <tr>
                                    <td><strong>${col.name}</strong></td>
                                    <td>${col.type}</td>
                                    <td>${col.nullable}</td>
                                    <td>${col.default || '-'}</td>
                                    <td>${col.primary_key ? 'üîë Yes' : 'No'}</td>
                                </tr>
                            `;
                        });
                        
                        detailsHTML += `</tbody></table>`;
                        
                        if (table.foreign_keys.length > 0) {
                            detailsHTML += `
                                <h4>Foreign Keys (${table.foreign_keys.length})</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Column</th>
                                            <th>References</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            table.foreign_keys.forEach(fk => {
                                detailsHTML += `
                                    <tr>
                                        <td><strong>${fk.column}</strong></td>
                                        <td>${fk.foreign_table}.${fk.foreign_column}</td>
                                    </tr>
                                `;
                            });
                            
                            detailsHTML += `</tbody></table>`;
                        }
                        
                        detailsDiv.innerHTML = detailsHTML;
                        detailsDiv.classList.add('visible');
                    } else {
                        detailsDiv.classList.remove('visible');
                    }
                });
                
                // Auto-fit after stabilization
                network.once('stabilizationIterationsDone', () => {
                    network.fit({ animation: false });
                });
                
            } catch (error) {
                console.error('Error loading schema:', error);
                document.getElementById('schema-network').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h2>‚ùå Failed to Load Schema</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Load on page load
        loadSchema();
    </script>
</body>
</html>
